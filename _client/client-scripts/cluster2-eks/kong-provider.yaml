name: '#{Config basename}-api-gateway'
description: Cluster 2 Kong API Gateway
resource_type: Gestalt::Configuration::Provider::Kong
properties:
  config:
    env:
      public:
        USERNAME: unused
        PASSWORD: currently
      private:
        KONG_LUA_PACKAGE_PATH: /usr/local/custom/?.lua;;
        KONG_CUSTOM_PLUGINS: gestalt-security-kong
        POSTGRES_NAME: cluster2-kong-db
        KONG_CLUSTER_ADVERTISE: $(POD_IP):7946
        KONG_CLUSTER_LISTEN: $(POD_IP):7946
    external_protocol: http
  linked_providers:
  - name: POSTGRES
    id: '#{Provider /root/default-postgres id}'
  services:
  - init:
      binding: eager
      singleton: true
    container_spec:
      name: cluster2-kng
      properties:
        cpus: 0.2
        memory: 1024
        accepted_resource_roles:
        - production
        - '*'
        env: {}
        num_instances: 1
        network: BRIDGE
        container_type: DOCKER
        image: '#{Config kong-image}'
        force_pull: true
        health_checks:
        - grace_period_seconds: 300
          interval_seconds: 60
          max_consecutive_failures: 3
          path: /
          port_index: 1
          port_type: index
          protocol: HTTP
          timeout_seconds: 20
        provider:
          id: '#{Provider /root/#{Config basename}-kubernetes id}'
        labels: {}
        port_mappings:
        - name: public-url
          protocol: tcp
          container_port: 8000
          lb_port: 8000
          expose_endpoint: true
          virtual_hosts:
          - '#{Config kong-virtual-host}'
        - name: service
          protocol: tcp
          container_port: 8001
          lb_port: 8001
          expose_endpoint: true
          virtual_hosts: []
